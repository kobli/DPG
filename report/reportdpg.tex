\documentclass[report,11pt]{elsarticle}
%\documentclass{article}[11pt,a4]
%\documentclass[11pt]{article}

\usepackage[lined,linesnumbered]{algorithm2e}
\usepackage{a4wide}
\usepackage{ae}
\usepackage[czech,english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{url}
\usepackage{pdfpages}
\usepackage{pgfplots}
\usepackage{diagbox}
\usepackage{float}

% fix for: czech babel breaks cline and cmidrule
\usepackage{regexpatch}
\makeatletter
% Change the `-` delimiter to an active character
\xpatchparametertext\@@@cmidrule{-}{\cA-}{}{}
\xpatchparametertext\@cline{-}{\cA-}{}{}
\makeatother

\paperwidth=210 true mm
\paperheight=297 true mm
\pdfpagewidth=210 true mm
\pdfpageheight=297 true mm

% Pro cestinu zakomentuj nasledujici radek
\selectlanguage{english}
% Pro anglictinu zakomentuj nasledujici radek
%\selectlanguage{czech}

% Znakem procenta zacina komentovaný řádek

%%%% Pokud chcete použít k formátování pseudokódu balík algorithm2e,
%%% odkomentujte jeden ze dvou následujících řádků
%\usepackage[lined,linesnumbered]{algorithm2e}
%\usepackage{algorithm2e}
% Tento balík slouží pro vkládání obrázků ve formátu EPS (encapsulated postscript)
%\usepackage{ctable}
%\DeclareGraphicsExtensions{.pdf}

% Remove the footer "Preprint submitted .."
\makeatletter
\def\ps@pprintTitle{%
	\let\@oddhead\@empty
	\let\@evenhead\@empty
	\def\@oddfoot{}%
	\let\@evenfoot\@oddfoot}

\begin{document}

\begin{frontmatter}

\title{Term project number 17\\ Hierarchical View-Frustum Culling for Z-buffer Rendering}

\author{Aleš Koblížek\footnote{B4M39DPG -- Aleš Koblížek, summer 2018/19}\\
Department of Computer Graphics and Interaction,\\ Faculty of Electrical Engineering, CTU in Prague
}

\date{}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%%  Abstract
%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{abstract}
Implement hierarchical view frustum culling for large scale scenes consisting of triangles. First, construct a bounding volume hierarchy (BVH) using top-down method, middle point subdivision. Avoid rendering such BVH nodes that cannot be visible (out of viewing frustum) usually known as view frustum culling.
\end{abstract}

  % Klicova slova k uloze
\begin{keyword}
view frustum culling, bounding volume hierarchy, middle point subdivision
\end{keyword}

\end{frontmatter}

%\maketitle

%% \input{./section1.tex}
%% \input{./section2.tex}
%% \input{./section3.tex}
%% \input{./section4.tex}
%% \input{./section5.tex}

%%%% -------------------------------------------------------- 
%\section{\label{SEC:Intro}Úvod}
\section{\label{SEC:Intro}Introduction}
View frustum culling is the process of identifying objects (or triangles) that lie outside the view frustum so they can be removed from the rendering pipeline. This reduces the load of the pipeline stages up to and including clipping. 
The goal of this project is to create an efficient implementation of a frustum culling algorithm for large static scenes, utilizing a bounding volume hierarchy, where the bounding volumes are axis-aligned bounding boxes.

%%%% -------------------------------------------------------- 
%\section{\label{SEC:Description}Popis algoritmu}
\section{\label{SEC:Description}Algorithm Description}
\subsection{Building the BVH}
First, the BVH must be built. The top-down method is used, which means that all triangles are put into a single node, the root, and the nodes are recursively split in two by dividing the triangles inside the node into two groups, according to chosen scheme. Each group is then passed to the newly created child node. This process is repeated until each node contains fewer triangles than specified threshold.

The chosen subdivision scheme is midpoint subdivision, which first calculates a midpoint and extents from triangle centroids along each axis and chooses the splitting axis as the one with largest extent, thus forming a splitting plane, which is perpendicular to this axis and contains the midpoint. Then it divides the primitives into two groups based on the position of their centroids relative to the splitting plane.

The shape of the tree is not known in advance, so it is easier to use the dynamic representation where each node is allocated separately and the children are linked by pointers. This is however not suitable for traversal because the nodes are not stored on subsequent memory locations, so the they can not be loaded into cache in advance. Also the pointers waste space in cache. To avoid this, the tree is transformed into an array representation, where left child is always the following node in the array and the index of the right child is stored inside the node. Therefore the order of nodes in the array corresponds to the DFS pre-order traversal.

\subsection{Hierarchy traversal}
By using a hierarchical data structure it is possible to lower the computational cost of culling when high accuracy is not needed or when the objects (meaning their bounding volume) are well aligned with the frustum. The hierarchy is traversed using DFS pre-order. Whenever a node is fully inside the frustum, there is no need to test its children and triangles of all leaves in this subtree can be sent for rendering.\footnote{Therefore it is beneficial to sort the triangles in order corresponding to the order of leaves in DFS traversal -- triangle ranges of siblings will be adjacent and their union will form a continuous range.} When a node is fully outside the frustum, all of its children will be outside as well so this subtree can be skipped. If the node intersects the frustum and it is not a leaf, it might still be possible to eliminate some triangles by recursing down the tree and doing more tests. In case the intersecting node is a leaf, all its triangles have to be rendered since it does not pay off to test every single triangle. Therefore the number of triangles in leaves should be suitably chosen.

\subsection{Frustum\,-\,box intersection test}
One approach to this problem is to transform the frustum into perspective coordinate system, therefore it becomes a box. Each bounding volume also has to be transformed, in case of AABB it means to transform all eight vertices and construct their AABB. Thus the problem becomes an intersection test of two AABBs, which can be solved by six comparisons. This approach pays most of its price on the vertex transformations, leaving no room for optimizations.

Second approach, the one used in this project, is to test the box against each of the frustum planes, either in world space or in model space.\footnote{The tests must be done in model space if the object transformation changes, so the BVH does not have to be rebuilt. Also if there are multiple objects with different transforms, the same BVH can be used for all of them.} It offers more room for optimizations, which will be described in further sections.

\subsection{Efficient plane\,-\,box intersection test}
Exact test cosists of testing position of eight points against a plane, meaning eight dot products and comparisons. There is a more efficient conservative algorithm, which can be used instead.\footnote{A conservative algorithm can be used, because when the result of the test is \emph{intersecting} instead of \emph{outside}, the only consequence is that the children will be tested as well.} The idea is that it is sufficient to test the two vertices that lie on the diagonal which is best aligned with the normal of the plane. They can be found by using the binary encoded signs of components of the plane normal vector as index into a lookup table. The vertex farther along the normal is called \emph{p-vertex}, the other one \emph{n-vertex}. If the \emph{n-vertex} is inside the plane, then the box is inside. Else if the \emph{p-vertex} is inside the plane, then the box is intersecting the plane. Otherwise it is outside the plane. The indices of the \emph{p-} and \emph{n- vertices} are the same for a given plane and all AABBs.

\subsection{Culling optimization techniques}
There are several possible optimizations. \emph{Plane masking} exploits the hierarchical structure -- when a node is inside a plane, all the child nodes must also be inside that plane, therefore the tests against those planes can be skipped. \emph{Plane coherency} tries to end the testing of box against set of plains earlier by starting with the plane the box was outside of last time. \emph{Octant test} is usable only for symetric frustum (meaning horizontal and vertical field of view is the same) and only if the radius of the bounding sphere of a node is not greater than the smallest distance from frustum center to any of its planes. It works by splitting the frustum into eight symetric octants, identifying the octant that contains the centroid of the node bounding sphere (or bounding sphere of the AABB, which may give a worse fit) and testing only against the three outer planes of that octant.

%%%% -------------------------------------------------------- 
%%\section{\label{SEC:Pitfalls}Potíže při implementaci}
\section{\label{SEC:Pitfalls}Implementation details}

Tady uvedete, co se Vám nedařilo a dařilo, s čím byly problémy a další
záležitosti týkající se implementace semestrální práce, či problém
čtení, konverze, či nalezení vhodných dat pro úlohu. Dále kde jste
strávili nejvíce času, kterou chybu v implementaci jste nejdéle
hledali a podobně. Časové nároky v hodinách (hodina = 60 minut) pro
vypracovaní semestrální práce včetně tohoto reportu. Rozdělení práce
mezi členy týmu, je-li úloha vypracována týmově.

%%%% -------------------------------------------------------- 
%\section{\label{SEC:Results}Naměřené výsledky}
\section{\label{SEC:Results}Results}
First, a suitable maximum number of triangles per leaf (\emph{MTPL}) has to be chosen. If it is too high, fewer nodes will be created and the culling will be faster, but less accurate and therefore more excess triangles will be sent for rendering, increasing the draw time. Figure \ref{GRAPH:mtpl} demonstrates that. Based on it, the \emph{MTPL} value was chosen to be $10^{4}$.

\begin{figure}[H]
\begin{tikzpicture}
\begin{axis}[
    enlargelimits=false,
		only marks,
		xlabel={Draw time $[ms]$},
		ylabel={BVH traverse time $[ms]$},
		ymax = 0.3,
		xmin = 0.1,
		xmax = 3,
		yticklabel style={/pgf/number format/fixed}
]
\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_100.stats};
\addlegendentry{$10^{2}$}

\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_1000.stats};
\addlegendentry{$10^{3}$}

\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_10000.stats};
\addlegendentry{$10^{4}$}

\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_100000.stats};
\addlegendentry{$10^{5}$}

\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_1000000.stats};
\addlegendentry{$10^{6}$}

\addplot+[] table [x index=2,y index=7]{../stats/asianDragon_10000000.stats};
\addlegendentry{$10^{7}$}

\end{axis}
\end{tikzpicture}
\caption{Scene draw time and BVH traverse time based on chosen \emph{MTPL} value. The samples for each \emph{MTPL} value were obtained using the same set of camera views in the Asian dragon scene.}
\label{GRAPH:mtpl}
\end{figure}

Now the culling optimization techniques can be evaluated. Table \ref{TAB:optim} shows speedups of each technique tested separately and all at once against the basic version of the algorithm. The culling time speedups were calculated from averages of circa 60 values, which were measured over one second using included camera view configurations. The \emph{MTPL} value was set to 10 to increase the number of generated nodes and improve the accuracy of measurements of traversal efficiency.

The obtained results are unclear. In \emph{A10} and \emph{forest} scenes all techniques produce a slowdown. Another odd behaviour occurs in \emph{city} and \emph{conference} scenes, where each technique separately results in a speedup, while when combined together they cause a slowdown. The reason for this might be either inaccurate measurements, or suboptimal implementation. After setting \emph{MTPL} to 10, the culling time is mostly in order of hundreds of microseconds, falling to tens for the \emph{A10} scene where only few nodes are visited.

\begin{table*}[t]
\begin{center}
\begin{tabular}{| r || r | r | r | r | r | r | r |}
	\hline
	Scene                                   & A10 & Asian dragon & city2 & city & conference & forest & teapots \\
	\#\,tris.                               & 219\,k & 7220\,k & 75\,k & 68\,k & 283\,k & 174\,k & 201\,k \\
	\#\,nodes                               & 68\,k & 2007\,k & 23\,k & 20\,k & 82\,k & 52\,k & 61\,k \\
	\#\,trav. nodes                         & 53  & 3721 & 1119 & 367 & 1363  & 573 & 1107 \\
	\diagbox[width=10em]{\\Optimization}{} &&&&&&& \\
\hline
\hline
	Plane masking                           & 0.8 & 2.1 & 1.5 & 1.6 & 3.1 & 0.4 & 0.9 \\
\hline
	Plane coherency                         & 0.7 & 0.5 & 1.9 & 0.9 & 1.1 & 0.3 & 1.3 \\
\hline
	Octant test                             & 0.7 & 1.6 & 0.8 & 1.2 & 1.6 & 0.3 & 1.5 \\
\hline
	All                                     & 1.0 & 1.5 & 1.4 & 0.9 & 1.0 & 0.6 & 1.6 \\
\hline
\end{tabular}
\end{center}
	\caption{Vief frustum culling speedups for individual and all optimization techniques (compared against no optimization) at selected views. \emph{MTPL} was set to 10.}
	\label{TAB:optim}
\end{table*}

Table \ref{TAB:configuration} contains the software and hardware configuration that was used for the measurments. The implementation uses a single thread, 

\begin{table*}[t]
\begin{center}
\begin{tabular}{| r || l |}
\hline
	CPU & Intel Xeon E3-1231 v3 @ 3.4\,GHz, 8\,MB cache, 4 cores, 8 threads \\
	RAM & 16\,GB \\
	GPU & Nvidia GeForce GTX 1070 Ti \\
\hline
\hline
	Operating system & MS Windows 10 \\
	Compiler & MSVC 2017\\
	Architecture & amd64 \\
	Compiler options & O2 (maximize speed), inline function expansion, enable intrinsic func. \\
\hline
\end{tabular}
\end{center}
	\caption{Hardware and software configuration used for measurements.}
	\label{TAB:optim}
\end{table*}


Příklad vložení souboru PDF je uveden na obrázku~\ref{fig:fig1} a ~\ref{fig:fig2}.

\begin{figure*}[!ht]
\begin{center}
  \includegraphics[width=0.3\textwidth]{cvut-logo-bw}
\caption{{\label{fig:fig1}}Příklad vloženého obrázku v PDF.}
\end{center}
\end{figure*}

\begin{figure*}[!ht]
\begin{center}
  \includegraphics[width=0.3\textwidth]{cvut-logo-bw}
  \includegraphics[width=0.3\textwidth]{cvut-logo-bw}
\caption{{\label{fig:fig2}}Příklad vložených obrázků v PDF vedle sebe.}
\end{center}
\end{figure*}

%%%% -------------------------------------------------------- 
%\section{\label{SEC:Conclusion}Závěr}
\section{\label{SEC:Conclusion}Conclusion}

V této části uvedete závěr, doporučení pro opakování implementace této
semestrální práce, omezení implementace či co se nepodařilo.

%%%% -------------------------------------------------------- 
%\section*{\label{SEC:ACK}Poděkování}
\section*{\label{SEC:ACK}Acknowledgment}

Práce je samostatná, ale pokud chcete někomu poděkovat například za
to, že Vás poslouchal při předběžné prezentaci či za přečtení a
kontrolu této zprávy a nalezení některých chyb, tak to tady uveďte.

%******************************************************************
% Tady nasleduje seznam literatury a to bud s pouzitim
% rucne usporadaneho seznamu ci s pouzitim system bibtex (prikaz
% \bibliographystyle{alpha} a \bibliography{dpgreport.bib}

%\bibliographystyle{abbrv}
%\bibliographystyle{alpha}
%\bibliography{dpgreport.bib}

% Druha moznost - rucne usporadany seznam literatury
\label{SEC:References}
%\section{Reference}
\renewcommand\bibname{References}
\begin{thebibliography}{10}

\bibitem[1]{Latex}
A. Balvínová a M. Bílý.
\newblock Textové informační systémy, sázecí systém \LaTeX, cvičení.
Skripta ČVUT-FEL, 1995.

\bibitem[2]{Danco}
V. Dančo.
\newblock Kapesní průvodce počítačovou typografií. Nakladatelství
Labyrint, Praha 1995.

\bibitem[3]{Rybicka}
J. Rybička.
\newblock \LaTeX\/ pro začátečníky. Nakladatelství Konvoj, 1999.

\bibitem[4]{GRUBER}
D. Gruber.
\newblock Kdo to má všechno číst, Nakladatelství Gruber, 1991.
(ISBN 80-900680-1-4).

\bibitem[5]{CSTUG} CSTUG: Úvod do \LaTeX{u}.
\newblock
\url{http://www.cstug.cz/latex/lm/frames.html}. Stránky z~roku 2009.

\bibitem[6]{CSTUGDOC}
CSTUG: Dokumentace a manuály k \LaTeX{u}.
\newblock \url{http://www.cstug.cz/documentation/index.html}

\end{thebibliography}

\end{document}
